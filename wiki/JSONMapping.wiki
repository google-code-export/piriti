#summary JSON Mapping with Piriti.

= Introduction =

Please note that starting with Piriti 0.3.5 the JSON data is no longer parsed using javascript eval() but the native JSON parser (or a javascript emulation if no native parser is available). Hence the JSON data must confirm to the syntax described at [http://json.org/ JSON.org]. Especially the keys must be enclosed in ". So instead of 
{{{
{ readonly: true, name: "Foo", createdAt: "08.01.2010", count: 20 }
}}}
you have to use
{{{
{ "readonly": true, "name": "Foo", "createdAt": "08.01.2010", "count": 20 }
}}}

= Mapping =
JSON mapping is done using the `JsonField` annotation:
{{{
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.FIELD)
public @interface JsonField
{
    /**
     * A "path" expression (the key of the JSON data) to select the JSON data.
     * Defaults to "" which means that the fields name is taken as a default.
     * 
     * @return
     */
    String value() default "";


    /**
     * The format to use when converting the JSON data to the fields type.
     * Defaults to "".
     * 
     * @return
     */
    String format() default "";
}
}}}

This annotation is specified for every field you want to map. If no path expression is given, the fields name is taken as a default. For some types you can specify a format which is used when converting the JSON data to the fields type:
<table cellpadding="3" cellspacing="0" border="1">
<tr>
<th align="left">Type</th>
<th>Default path expression</th>
<th align="left">Description / Format options</th>
</tr>
<tr>
<td>boolean, Boolean</td>
<td>`<fieldname>`</td>
<td>Must be a JSON boolean. No format supported. If specified it is ignored.</td>
</tr>
<tr>
<td>byte, Byte</td>
<td>`<fieldname>`</td>
<td>Must be a JSON number. No format supported. If specified it is ignored.</td>
</tr>
<tr>
<td>char, Character</td>
<td>`<fieldname>`</td>
<td>Must be a JSON string. No format supported. If specified it is ignored.</td>
</tr>
<tr>
<td>java.util.Date</td>
<td>`<fieldname>`</td>
<td>Must be a JSON string. If no format is specified a [http://piriti.googlecode.com/svn/site/apidocs/constant-values.html#name.pehl.gwt.piriti.client.converter.DateConverter.DEFAULT_FORMAT default format] is used.<br/> 
Otherwise must be a valid date format as described by [http://google-web-toolkit.googlecode.com/svn/javadoc/2.0/com/google/gwt/i18n/client/DateTimeFormat.html DateTimeFormat]</td>
</tr>
<tr>
<td>double, Double</td>
<td>`<fieldname>`</td>
<td>If no format is specified the JSON data is expected to be a JSON number, otherwise the JSON data is expected to be a JSON string and the format must be a valid number format as described by  [http://google-web-toolkit.googlecode.com/svn/javadoc/2.0/com/google/gwt/i18n/client/NumberFormat.html NumberFormat]</td>
</tr>
<tr>
<td>float, Float</td>
<td>`<fieldname>`</td>
<td>If no format is specified the JSON data is expected to be a JSON number, otherwise the JSON data is expected to be a JSON string and the format must be a valid number format as described by  [http://google-web-toolkit.googlecode.com/svn/javadoc/2.0/com/google/gwt/i18n/client/NumberFormat.html NumberFormat]</td>
</tr>
<tr>
<td>int, Integer</td>
<td>`<fieldname>`</td>
<td>If no format is specified the JSON data is expected to be a JSON number, otherwise the JSON data is expected to be a JSON string and the format must be a valid number format as described by  [http://google-web-toolkit.googlecode.com/svn/javadoc/2.0/com/google/gwt/i18n/client/NumberFormat.html NumberFormat]</td>
</tr>
<tr>
<td>long, Long</td>
<td>`<fieldname>`</td>
<td>If no format is specified the JSON data is expected to be a JSON number, otherwise the JSON data is expected to be a JSON string and the format must be a valid number format as described by  [http://google-web-toolkit.googlecode.com/svn/javadoc/2.0/com/google/gwt/i18n/client/NumberFormat.html NumberFormat]</td>
</tr>
<tr>
<td>short, Short</td>
<td>`<fieldname>`</td>
<td>Must be a JSON number. No format supported. If specified it is ignored.</td>
</tr>
<tr>
<td>String</td>
<td>`<fieldname>`</td>
<td>No format supported. If specified it is ignored.</td>
</tr>
<tr>
<td>Enums</td>
<td>`<fieldname>`</td>
<td>No format supported. If specified it is ignored.</td>
</tr>
<tr>
<td>All types T for which a JsonReader`<T>` is registered</td>
<td>`<fieldname>`</td>
<td>No format supported. If specified it is ignored.</td>
</tr>
<tr>
<td>Arrays of the above types</td>
<td>`<fieldname>`</td>
<td>If a format is specified it is applied for all array elements.</td>
</tr>
<tr>
<td>Typed collections of the above types</td>
<td>`<fieldname>`</td>
<td>If a format is specified it is applied for all collection elements.</td>
</tr>
</table>

= Example = 
Let's assume you want to map the following JSON data
{{{
{
    "isbn": "978-0345417954", 
    "pages": 432,
    "title": "The Hotel New Hampshire",
    "author": {
        "firstname": "John",
        "surname": "Irving", 
    },
    "reviews": [
        "A hectic gaudy saga with the verve of a Marx Brothers movie.", 
        "Rejoice! John Irving has written another book according to your world.", 
        "Spellbinding, intensely human, a high-wire act of dazzling virtuosity."
    ]
}    
}}}

Therefore you have the following model classes in your GWT client
{{{
public class Book
{
    String isbn;
    int pages;
    String title;
    Author author;
    List<String> reviews;
}

public class Author
{
    String firstname;
    String surname;
}
}}}

To map the JSON data to your model, all you have to do is annotate the relevant fields in your model and define an interface of type JsonReader`<T>`;
{{{
public class Book
{
    interface BookReader extends JsonReader<Book> {}
    public static final BookReader JSON = GWT.create(BookReader.class);

    @JsonField String isbn;
    @JsonField int pages;
    @JsonField String title;
    @JsonField Author author;
    @JsonField List<String> reviews;
}

public class Author
{
    interface AuthorReader extends JsonReader<Author> {}
    public static final AuthorReader JSON = GWT.create(AuthorReader.class);

    @JsonField String firstname;
    @JsonField String surname;
}
}}}

Now you can map the JSON data to your model by calling
{{{
String jsonString = ...; // the above JSON data
Book book = Book.JSON.read(jsonString);
}}}